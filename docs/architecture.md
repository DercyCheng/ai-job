# 系统架构设计

## 整体架构

```
                                 ┌─────────────────┐
                                 │                 │
                                 │   API Gateway   │
                                 │   (Go/Gin)      │
                                 │                 │
                                 └─────────────────┘
                                         │
                          ┌──────────────┼──────────────┐
                          │              │              │
                 ┌────────▼─────┐ ┌──────▼─────┐ ┌──────▼─────┐
                 │              │ │            │ │            │
                 │  Auth Service│ │MCP Service │ │Admin Service│
                 │  (Go)        │ │(Go)        │ │(Go)        │
                 │              │ │            │ │            │
                 └──────────────┘ └──────┬─────┘ └────────────┘
                                         │
                          ┌──────────────┼──────────────┐
                          │              │              │
                 ┌────────▼─────┐ ┌──────▼─────┐ ┌──────▼─────┐
                 │              │ │            │ │            │
                 │ Model Worker │ │Model Worker│ │Model Worker│
                 │ (Python)     │ │(Python)    │ │(Python)    │
                 │              │ │            │ │            │
                 └──────────────┘ └────────────┘ └────────────┘
                    ▲               ▲               ▲
                    │               │               │
                    ▼               ▼               ▼
                 ┌────────────────────────────────────────────┐
                 │                                            │
                 │          本地模型部署和管理层              │
                 │       (DeepSeek V3, Qwen3, 等)            │
                 │                                            │
                 └────────────────────────────────────────────┘
```

## 通信协议

系统支持双协议通信架构:

```
            ┌──────────────────┐      ┌──────────────────┐
客户端 ─────┤   HTTP/REST API  │      │    gRPC API      │
            └──────────────────┘      └──────────────────┘
                      │                        │
                      ▼                        ▼
                ┌────────────────────────────────────┐
                │                                    │
                │        协议转换与适配层           │
                │                                    │
                └────────────────────────────────────┘
                      │                        │
                      ▼                        ▼
               ┌─────────────┐          ┌─────────────┐
               │ 内部服务调用 │          │ 内部服务调用 │
               │  (HTTP)     │          │   (gRPC)    │
               └─────────────┘          └─────────────┘
```

## 核心组件

### 1. API Gateway

- 使用 Go 和 Gin 框架实现
- 提供统一的 API 入口
- 支持 HTTP/REST 和 gRPC 双协议接入
- 实现负载均衡、限流、熔断等功能
- 处理路由转发和请求分发
- 处理协议转换和适配

### 2. MCP Service (Model Context Protocol 服务)

- 核心服务，基于 MCP 协议设计
- 支持 HTTP 和 gRPC 双协议通信
- 管理模型生命周期
- 实现请求上下文管理
- 处理模型间通信和数据流转

### 3. Auth Service

- 身份验证和授权服务
- 用户管理和 API 密钥管理
- 权限控制
- 支持 HTTP 和 gRPC 双协议认证

### 4. Admin Service

- 系统管理和监控
- 资源配置
- 日志分析
- 本地模型管理和部署

### 5. Model Workers

- 使用 Python 实现的模型执行环境
- 支持多种 AI 模型接入
- 弹性扩缩容
- 优化的本地模型执行环境

### 6. 本地模型部署层

- 支持 DeepSeek V3、Qwen3 等大型模型本地部署
- 模型量化与优化
- 模型资源调度
- 多卡并行推理
- 支持模型热更新

## 数据流向

1. 客户端通过 HTTP/REST 或 gRPC 发送请求到 API Gateway
2. Gateway 进行验证并路由请求到相应服务
3. MCP Service 处理模型调用逻辑
4. 请求分发到可用的 Model Worker
5. Worker 调用本地部署的模型 (如 DeepSeek V3、Qwen3) 执行推理
6. 结果通过原协议返回给客户端

## 高可用设计

- 服务注册与发现: 使用 etcd
- 故障检测与恢复: 健康检查机制
- 数据一致性: 分布式事务
- 模型服务冗余: 热备份机制

## 安全设计

- 通信加密: TLS/SSL
- 身份验证: JWT/OAuth2
- 权限控制: RBAC 模型
- 双协议安全层: 统一的安全策略

## 本地模型支持

### DeepSeek V3 模型集成

- 模型类型: 大规模语言模型
- 模型规格: 7B/14B/42B
- 支持的功能: 文本生成、聊天、代码生成、多语言翻译
- 量化支持: INT4/INT8
- 硬件要求: NVIDIA GPU(s) 最小 24GB 显存 (7B), 32GB+ (14B), 80GB+ (42B)

### Qwen3 模型集成

- 模型类型: 大规模语言模型
- 模型规格: 0.5B/1.5B/7B/14B/72B
- 支持的功能: 文本生成、聊天、多模态、辅助工具调用
- 量化支持: INT4/INT8
- 硬件要求: NVIDIA GPU(s) 最小 8GB 显存 (0.5B), 16GB (1.5B), 24GB (7B), 32GB+ (14B), 80GB+ (72B)

### 本地模型部署架构

```
┌────────────────────────────────────────────────────────────┐
│                       模型管理服务                         │
├────────────────────────────────────────────────────────────┤
│ ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐  │
│ │ 模型注册中心 │  │ 模型版本控制 │  │ 模型参数配置中心 │  │
│ └──────────────┘  └──────────────┘  └──────────────────┘  │
└────────────────────────────────────────────────────────────┘
                             │
                             ▼
┌────────────────────────────────────────────────────────────┐
│                       模型部署服务                         │
├────────────────────────────────────────────────────────────┤
│ ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐  │
│ │ 模型下载     │  │ 模型初始化   │  │ 模型热更新       │  │
│ └──────────────┘  └──────────────┘  └──────────────────┘  │
└────────────────────────────────────────────────────────────┘
                             │
                             ▼
┌────────────────────────────────────────────────────────────┐
│                       模型推理服务                         │
├────────────────────────────────────────────────────────────┤
│ ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐  │
│ │ DeepSeek V3  │  │ Qwen3        │  │ 其他本地模型     │  │
│ └──────────────┘  └──────────────┘  └──────────────────┘  │
└────────────────────────────────────────────────────────────┘
```
